# 天气MCP配置指南

## 概述

本项目已经集成了天气MCP（Model Context Protocol）功能，让DeepSeek模型能够获取实时天气数据。当用户询问天气相关问题时，系统会自动调用天气API获取实时数据，然后让DeepSeek基于这些数据回答用户。

## 功能特性

- 🌤️ **实时天气查询**：支持查询任意城市的实时天气
- 📅 **天气预报**：提供未来3天的天气预报
- 🕐 **时间查询**：获取当前时间
- 🧮 **计算器**：支持基本数学计算
- 🔄 **流式响应**：保持原有的流式聊天体验

## 配置步骤

### 1. 获取天气API密钥

推荐使用和风天气API（免费额度充足）：

1. 访问 [和风天气官网](https://dev.qweather.com/)
2. 注册账号并创建应用
3. 获取API密钥

### 2. 配置环境变量

在项目根目录创建 `.env` 文件：

```bash
# DeepSeek API配置
DEEPSEEK_API_KEY=your_deepseek_api_key_here

# 天气API配置（和风天气）
WEATHER_API_KEY=your_weather_api_key_here

# 其他配置...
DB_HOST=localhost
DB_PORT=3306
DB_NAME=your_database_name
DB_USER=your_database_user
DB_PASSWORD=your_database_password
JWT_SECRET=your_jwt_secret_here
PORT=3000
NODE_ENV=development
```

### 3. 安装依赖

确保已安装所需依赖：

```bash
npm install axios
```

## 使用方法

### 天气查询示例

用户可以通过以下方式查询天气：

- "今天珠海天气怎么样？"
- "北京天气"
- "上海明天天气"
- "深圳后天会下雨吗？"

### 时间查询示例

- "现在几点了？"
- "今天是什么时间？"
- "现在的时间"

### 计算器示例

- "计算 15 + 25"
- "算一下 100 * 3"
- "50 除以 2 等于多少"

## 技术实现

### 核心文件

1. **`utils/weatherService.js`** - 天气服务模块
   - 调用和风天气API获取实时天气
   - 支持城市名称自动识别
   - 格式化天气信息

2. **`utils/mcpTools.js`** - MCP工具管理器
   - 检测用户消息是否需要工具调用
   - 解析工具调用参数
   - 执行各种工具功能

3. **`routes/ai/chat.js`** - 聊天路由（已更新）
   - 集成MCP功能
   - 自动检测工具调用需求
   - 将工具结果注入到AI对话中

### 工作流程

1. 用户发送消息到聊天接口
2. 系统检测消息是否包含工具调用关键词
3. 如果检测到工具调用需求，解析具体工具和参数
4. 执行相应的工具（如天气查询）
5. 将工具执行结果作为系统消息注入到对话中
6. 调用DeepSeek API，让AI基于工具结果回答用户

## API接口

### 天气API（和风天气）

- **实时天气**：`GET /v7/weather/now`
- **3天预报**：`GET /v7/weather/3d`
- **城市查询**：`GET /v7/geo/lookup`

### 聊天接口

- **POST** `/ai/chat`
- **请求体**：`{ messages: [...] }`
- **响应**：Server-Sent Events流式响应

## 错误处理

系统包含完善的错误处理机制：

- API调用失败时的友好错误提示
- 城市名称无法识别时的提示
- 网络异常时的重试机制
- 工具执行失败时的降级处理

## 扩展功能

可以轻松添加更多MCP工具：

1. 在 `mcpTools.js` 中添加新的工具函数
2. 在 `needsToolCall` 方法中添加关键词检测
3. 在 `parseToolCall` 方法中添加参数解析逻辑

## 注意事项

1. **API密钥安全**：请妥善保管API密钥，不要提交到代码仓库
2. **请求频率**：注意API调用频率限制
3. **错误处理**：生产环境建议添加更详细的日志记录
4. **缓存机制**：可以考虑添加天气数据缓存，减少API调用

## 故障排除

### 常见问题

1. **天气API调用失败**
   - 检查API密钥是否正确
   - 确认网络连接正常
   - 查看API调用频率是否超限

2. **城市名称无法识别**
   - 尝试使用更标准的城市名称
   - 检查城市名称是否包含特殊字符

3. **DeepSeek API错误**
   - 检查DeepSeek API密钥
   - 确认API调用格式正确

### 调试方法

1. 查看控制台日志输出
2. 检查网络请求状态
3. 验证环境变量配置

## 更新日志

- **v1.0.0** - 初始版本，支持天气、时间、计算器功能
- 支持流式响应
- 集成和风天气API
- 自动工具调用检测 