# 天气MCP功能说明

## 项目结构

```
clwy-api/
├── services/                    # 服务层
│   ├── chatService.js          # 聊天服务
│   └── responseService.js      # 响应处理服务
├── utils/                      # 工具层
│   ├── weatherService.js       # 天气服务
│   └── mcpTools.js            # MCP工具管理器
├── routes/ai/                  # 路由层
│   └── chat.js                # 聊天路由
└── WEATHER_MCP_SETUP.md       # 详细配置指南
```

## 功能特性

- 🌤️ **实时天气查询**：支持查询任意城市的实时天气
- 📅 **天气预报**：提供未来3天的天气预报
- 🕐 **时间查询**：获取当前时间
- 🧮 **计算器**：支持基本数学计算
- 🔄 **流式响应**：保持原有的流式聊天体验

## 架构设计

### 1. 服务层 (Services)
- **chatService.js**: 处理聊天逻辑，包括工具调用检测和DeepSeek API调用
- **responseService.js**: 处理响应逻辑，包括流式响应和错误处理

### 2. 工具层 (Utils)
- **weatherService.js**: 天气API服务，获取实时天气和预报数据
- **mcpTools.js**: MCP工具管理器，检测和执行各种工具功能

### 3. 路由层 (Routes)
- **chat.js**: 聊天接口路由，简洁的控制器逻辑

## 工作流程

1. **请求验证**: 验证请求参数和配置
2. **消息处理**: 检测是否需要工具调用
3. **工具执行**: 执行相应的工具（天气、时间、计算器）
4. **消息增强**: 将工具结果注入到对话中
5. **API调用**: 调用DeepSeek API
6. **流式响应**: 将响应流式返回给前端

## 使用方法

### 天气查询
- "今天北京天气怎么样？"
- "珠海现在天气如何？"
- "上海明天会下雨吗？"

### 时间查询
- "现在几点了？"
- "今天是什么时间？"

### 计算器
- "计算 15 + 25"
- "算一下 100 * 3"

## 配置要求

在 `.env` 文件中配置：
```bash
DEEPSEEK_API_KEY=your_deepseek_api_key
WEATHER_API_KEY=your_weather_api_key
```

## 优势

- **解耦设计**: 业务逻辑分离到不同的服务层
- **易于维护**: 清晰的代码结构和职责分离
- **易于扩展**: 可以轻松添加新的工具功能
- **错误处理**: 完善的错误处理机制
- **性能优化**: 减少不必要的日志输出 